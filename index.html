<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ceklist Kepegawaian RSUD Talaud</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --bs-gold: #D4AF37;
            --bs-red: #A52A2A;
            --bs-gold-rgb: 212, 175, 55;
            --bs-red-rgb: 165, 42, 42;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding-top: 70px; /* Padding untuk header */
            padding-bottom: 70px; /* Padding untuk navbar bawah */
            overflow-x: hidden;
            font-size: 0.9rem;
        }

        /* Header Styling */
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1020;
            background: linear-gradient(90deg, var(--bs-gold), var(--bs-red));
            color: white;
            padding: 10px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .main-header h4 {
            margin: 0;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .main-header p {
            margin: 0;
            font-size: 0.8rem;
        }

        /* Styling untuk konten halaman */
        .page-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card Styling */
        .main-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            margin: 10px 0;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(90deg, var(--bs-gold), var(--bs-red));
            color: white;
            font-weight: 600;
            padding: 8px 15px;
            font-size: 0.9rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .card-body {
            padding: 10px !important;
        }

        /* Employee List Styling */
        .employee-list .list-group-item {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 12px 15px;
        }
        .employee-list .list-group-item:hover {
            background-color: #f8f9fa;
        }
        .employee-list .progress {
            height: 5px;
        }

        /* Custom Checklist Styling */
        .custom-list-group {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .custom-list-group .list-group-item {
            border: none;
            border-bottom: 1px solid #e9ecef;
            padding: 8px 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .custom-list-group .list-group-item:last-child {
            border-bottom: none;
        }

        .custom-list-group .list-group-item:hover {
            background-color: #f8f9fa;
            transform: translateX(3px);
        }
        
        .custom-list-group .list-group-item.checked {
            background-color: #fff3cd;
            border-left: 4px solid var(--bs-gold);
        }

        .form-check-input:checked {
            background-color: var(--bs-gold);
            border-color: var(--bs-gold);
        }

        /* Navbar Bawah Styling */
        .bottom-navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            background-color: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.08);
            border-top: 1px solid #dee2e6;
        }

        .bottom-navbar .nav-link {
            color: var(--bs-secondary);
            padding: 8px 4px; /* Padding diperbesar sedikit */
            font-size: 0.7rem; /* Font diperbesar */
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 2px 1px;
        }

        .bottom-navbar .nav-link.active {
            color: white;
            background: linear-gradient(45deg, var(--bs-gold), var(--bs-red));
            font-weight: bold;
        }
        .bottom-navbar .nav-link.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .bottom-navbar .nav-link i {
            font-size: 1.3rem; /* Ikon diperbesar */
            display: block;
            margin-bottom: 2px;
        }
        
        /* Tombol Aksi */
        .action-btn {
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            font-size: 0.85rem;
            padding: 5px 10px;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn-gradient {
            background: linear-gradient(45deg, var(--bs-gold), var(--bs-red));
            color: white;
        }

        /* Progress Bar Styling */
        .progress {
            height: 20px;
            border-radius: 10px;
        }

        .progress-bar {
            font-weight: bold;
            font-size: 0.8rem;
            background: linear-gradient(90deg, var(--bs-gold), var(--bs-red));
        }
        
        /* Rangkuman Item Styling */
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item i {
            font-size: 1rem;
        }
        .status-done { color: var(--bs-gold); }
        .status-pending { color: var(--bs-secondary); }

        /* Toast Notification Styling */
        .toast-container {
            position: fixed;
            top: 80px; /* Posisi dari atas disesuaikan dengan header */
            right: 10px;
            z-index: 1055;
        }
        .toast {
            background: linear-gradient(45deg, #ffffff, #f8f9fa);
            border-left: 4px solid var(--bs-gold);
            font-size: 0.85rem;
        }

        /* Logo di Pojok Kanan Atas */
        #logo {
            position: fixed;
            top: 75px; /* Disesuaikan dengan header */
            right: 10px; /* Dipindahkan dari kiri ke kanan */
            width: 40px;
            height: 40px;
            z-index: 1019;
            border-radius: 50%;
            background-color: white;
            padding: 3px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <!-- Main Header -->
    <header class="main-header">
        <h4>CEKLIST KEPEGAWAIAN</h4>
        <p>RSUD KABUPATEN KEPULAUAN TALAUD</p>
    </header>

    <!-- Logo di Pojok Kanan Atas -->
    <img id="logo" src="https://z-cdn-media.chatglm.cn/files/48ad0cdb-0296-4fc5-8a89-4195e27da998_talaud_400kb.png?auth_key=1864562517-46b7496151e74edc9a396f55bfc35571-0-20140d03f3932e7c551082915f931a18" alt="Logo Kabupaten Talaud">

    <!-- Toast Container untuk Notifikasi -->
    <div class="toast-container">
        <div class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true" id="saveNotificationToast">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span id="toastMessage">Data berhasil disimpan.</span>
                </div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- PAGE 1: DAFTAR PEGAWAI -->
        <div id="page-daftar-pegawai" class="page-content active">
            <div class="card main-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-people-fill"></i> DAFTAR PEGAWAI</span>
                    <button class="btn btn-light btn-sm action-btn" onclick="showAddEmployeeModal()">
                        <i class="bi bi-plus-circle"></i> Tambah Baru
                    </button>
                </div>
                <div class="card-body p-0" style="max-height: 60vh; overflow-y: auto;">
                    <ul class="list-group list-group-flush employee-list" id="employee-list">
                        <!-- Daftar pegawai akan di-generate oleh JavaScript -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- PAGE 2: CEKLIST PEGAWAI -->
        <div id="page-ceklist" class="page-content">
            <div class="card main-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list-check"></i> <span id="detail-employee-name">Nama Pegawai</span></span>
                    <button class="btn btn-light btn-sm action-btn" onclick="showEmployeeList()">
                        <i class="bi bi-arrow-left"></i> Kembali
                    </button>
                </div>
                <div class="card-body p-0" style="max-height: 60vh; overflow-y: auto;">
                    <ul class="custom-list-group" id="checklist-detail">
                        <!-- Daftar item akan di-generate oleh JavaScript -->
                    </ul>
                </div>
                <div class="card-footer text-end p-2 d-flex justify-content-between flex-wrap gap-1">
                    <button class="btn btn-danger action-btn btn-sm" onclick="deleteCurrentEmployee()">
                        <i class="bi bi-trash3"></i> Hapus
                    </button>
                    <button class="btn btn-warning action-btn btn-sm" onclick="exportCurrentEmployeeData()">
                        <i class="bi bi-download"></i> Export
                    </button>
                    <button class="btn btn-info action-btn btn-sm text-white" onclick="sendCurrentEmployeeDataToTelegram()">
                        <i class="bi bi-send"></i> Kirim ke Telegram
                    </button>
                </div>
            </div>
        </div>

        <!-- PAGE 3: DAFTAR SELESAI -->
        <div id="page-selesai" class="page-content">
            <div class="card main-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-check-circle"></i> FILE YANG SUDAH LENGKAP</span>
                    <button class="btn btn-light btn-sm action-btn" onclick="showPage('ceklist')">
                        <i class="bi bi-arrow-left"></i> Kembali ke Ceklist
                    </button>
                </div>
                <div class="card-body p-0" style="max-height: 60vh; overflow-y: auto;">
                    <ul class="custom-list-group" id="checklist-completed">
                        <!-- Item selesai akan di-generate oleh JavaScript -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- PAGE 4: DAFTAR YANG BELUM LENGKAP -->
        <div id="page-proses" class="page-content">
            <div class="card main-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-x-circle"></i> DAFTAR YANG BELUM LENGKAP</span>
                    <button class="btn btn-light btn-sm action-btn" onclick="showPage('ceklist')">
                        <i class="bi bi-arrow-left"></i> Kembali ke Ceklist
                    </button>
                </div>
                <div class="card-body p-0" style="max-height: 60vh; overflow-y: auto;">
                    <ul class="custom-list-group" id="checklist-inprogress">
                        <!-- Item dalam proses akan di-generate oleh JavaScript -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- PAGE 5: RANGKUMAN -->
        <div id="page-rangkuman" class="page-content">
            <div class="card main-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-clipboard-data"></i> RANGKUMAN KELENGKAPAN FILE</span>
                    <button class="btn btn-light btn-sm action-btn" onclick="showPage('ceklist')">
                        <i class="bi bi-arrow-left"></i> Kembali ke Ceklist
                    </button>
                </div>
                <div class="card-body text-center">
                    <h6 class="card-title" id="summary-employee-name" style="cursor: pointer; color: var(--bs-red);" onclick="showSummaryModal()">Nama Pegawai</h6>
                    <p class="text-muted">Klik nama untuk melihat detail</p>
                </div>
                <div class="card-footer text-end p-2 d-flex justify-content-between flex-wrap gap-1">
                    <button class="btn btn-danger action-btn btn-sm" onclick="deleteCurrentEmployee()">
                        <i class="bi bi-trash3"></i> Hapus
                    </button>
                    <button class="btn btn-warning action-btn btn-sm" onclick="exportCurrentEmployeeData()">
                        <i class="bi bi-download"></i> Export
                    </button>
                    <button class="btn btn-info action-btn btn-sm text-white" onclick="sendCurrentEmployeeDataToTelegram()">
                        <i class="bi bi-send"></i> Kirim ke Telegram
                    </button>
                </div>
            </div>
        </div>

        <!-- PAGE 6: PENGATURAN -->
        <div id="page-pengaturan" class="page-content">
            <div class="card main-card">
                <div class="card-header">
                    <i class="bi bi-gear-fill"></i> PENGATURAN DATA
                </div>
                <div class="card-body">
                    <h6>Kelola Data Semua Pegawai</h6>
                    <p class="text-muted">Di sini Anda dapat mengekspor, mengimpor, atau menghapus semua data pegawai sekaligus.</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-gradient action-btn" onclick="exportAllData()">
                            <i class="bi bi-download"></i> Export Semua Data
                        </button>
                        <button class="btn btn-secondary action-btn" onclick="document.getElementById('importAllFile').click()">
                            <i class="bi bi-upload"></i> Impor Data dari File
                        </button>
                        <input type="file" id="importAllFile" accept=".json" style="display: none;" onchange="importAllData(event)">
                        <button class="btn btn-danger action-btn" onclick="clearAllEmployeeData()">
                            <i class="bi bi-exclamation-triangle"></i> Hapus Semua Data Pegawai
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Pegawai Baru -->
    <div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addEmployeeModalLabel">Tambah Data Pegawai Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modalEmployeeNameInput" class="form-label">Nama Pegawai</label>
                        <input type="text" class="form-control" id="modalEmployeeNameInput" placeholder="Masukkan Nama Lengkap">
                    </div>
                    <hr>
                    <h6>Checklist Kelengkapan File (Opsional)</h6>
                    <p class="text-muted">Anda dapat mengisi checklist ini sekarang atau nanti.</p>
                    <div style="max-height: 40vh; overflow-y: auto;">
                        <ul class="custom-list-group" id="checklist-modal">
                            <!-- Daftar item akan di-generate oleh JavaScript -->
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-gradient" onclick="saveNewEmployee()">Simpan Pegawai</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detail Rangkuman -->
    <div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="summaryModalLabel">Rangkuman Kelengkapan File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 class="card-title" id="modal-summary-employee-name">Nama Pegawai</h6>
                    <div class="mb-3">
                        <label for="modalProgressBar" class="form-label" style="font-size: 0.85rem;">Persentase Kelengkapan</label>
                        <div class="progress">
                            <div id="modalProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                    </div>
                    <h6 class="mt-3 mb-2">Detail Status File:</h6>
                    <div id="modal-summary-list">
                        <!-- Daftar rangkuman akan di-generate oleh JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="navbar bottom-navbar">
        <ul class="nav nav-justified w-100">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showPage('daftar-pegawai', this)">
                    <i class="bi bi-people"></i>
                    <span>Daftar</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="#" id="nav-ceklist" onclick="showPage('ceklist', this)">
                    <i class="bi bi-list-check"></i>
                    <span>Ceklist</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="#" id="nav-rangkuman" onclick="showPage('rangkuman', this)">
                    <i class="bi bi-clipboard-data"></i>
                    <span>Rangkuman</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showPage('pengaturan', this)">
                    <i class="bi bi-gear"></i>
                    <span>Pengaturan</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const checklistData = [
            "IJAZAH SD", "IJAZAH SMP", "IJAZAH SMA/SEDERAJAT", "IJAZAH DIPLOMA (D1,D2,D3)", "IJAZAH SARJANA (S1,S2,S3)",
            "TRANSKRIP NILAI TERAKHIR", "DAFTAR RIWAYAT HIDUP (DRH)", "AKTA KELAHIRAN (SUAMI/ISTRI/ANAK)", "KARTU KELUARGA", "SK CPNS (80%)",
            "SK PNS (100%)", "SK KENAIKAN PANGKAT PERTAMA SAMPAI PANGKAT TERAKHIR", "SK PENGANGKATAN PERTAMA KALI DALAM JABATAN FUNGSIONAL", "SK PELANTIKAN BAGI YANG PERNAH MENDUDUKI JABATAN STRUKTURAL", "SK KONVERSI NIP",
            "SK KENAIKAN GAJI BERKALA TERAKHIR", "SK MUTASI/NOTA DINAS BAGI YANG DIMUTASIKAN", "SURAT TANDA TAMAT PELATIHAN PRAJABATAN", "BERITA ACARA PENGAMBILAN SUMPAH/ JANJI PNS", "KARTU PEGAWAI (KARPEG)",
            "KARTU PEGAWAI ELEKTRONIK (KPE)", "KARTU SUAMI/ISTRI", "KARTU ASPEN", "KARTU PESERTA BPJS KESEHATAN (SUAMI/ISTRI/ANAK)", "NPWP",
            "SURAT TANDA REGISTRASI (STR)", "SURAT IZIN PRAKTEK (SIP)", "KARTU ANGGOTA PROFESI", "SURAT PENUGASAN KLINIK (SPK)", "RINCIAN KEWENANGAN KLINIS (RKK)",
            "SURAT TUGAS", "URAIAN TUGAS", "PENETAPAN ANGKA KREDIT (PAK) TERAKHIR", "SKP TAHUN 2020 & 2021", "SK KEPANITIAAN/ KELOMPOK KERJA DI RUMAH SAKIT",
            "SERTIFIKAT DIKLAT STRUKTURAL / FUNGSIONAL", "SERTIFIKAT BIMTEK / WORKSHOP / SEMINAR", "PAS FOTO WARNA LATAR MERAH 4X6 (1 LEMBAR) PAKAIAN DINAS KHUSUK (KHEKI)"
        ];

        const storageKey = 'pegawaiDataList_talaud';
        // --- KONFIGURASI TELEGRAM ---
        const telegramBotToken = '8286354592:AAG7sg-pVEOUuISTCSvPZEObUWQLBzLle7o';
        const telegramChatId = '5537854100';

        let currentEmployeeId = null;
        let saveNotificationToast;
        let addEmployeeModal;
        let summaryModal;

        // --- DATA MANAGEMENT ---
        function getAllEmployees() {
            const savedData = localStorage.getItem(storageKey);
            return savedData ? JSON.parse(savedData) : [];
        }

        function saveAllEmployees(data) {
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        function findEmployeeById(id) {
            const employees = getAllEmployees();
            return employees.find(emp => emp.id === id);
        }

        function generateUniqueId() {
            return `emp_${Date.now()}`;
        }

        // --- UI RENDERING ---
        function renderEmployeeList() {
            const employees = getAllEmployees();
            const listContainer = document.getElementById('employee-list');
            listContainer.innerHTML = '';

            if (employees.length === 0) {
                listContainer.innerHTML = '<li class="list-group-item text-center text-muted">Belum ada data pegawai. Klik "Tambah Baru" untuk memulai.</li>';
                return;
            }

            employees.forEach(emp => {
                const completedCount = Object.values(emp.checks).filter(isChecked => isChecked).length;
                const percentage = Math.round((completedCount / checklistData.length) * 100);

                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-person-circle me-2"></i>
                            <strong>${emp.employeeName || 'Tanpa Nama'}</strong>
                        </div>
                        <div style="width: 30%;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${percentage}%</div>
                            </div>
                        </div>
                    </div>
                `;
                li.onclick = () => loadEmployeeDetail(emp.id);
                listContainer.appendChild(li);
            });
        }

        function renderChecklist(containerId, employeeData, isEditable = false) {
            const listContainer = document.getElementById(containerId);
            listContainer.innerHTML = '';
            const checks = employeeData ? employeeData.checks : {};

            checklistData.forEach((item, index) => {
                const checkId = `check${index + 1}`;
                const isChecked = checks ? checks[checkId] : false;

                const li = document.createElement('li');
                li.className = `list-group-item ${isChecked ? 'checked' : ''}`;
                li.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="${containerId}-${checkId}" ${isChecked ? 'checked' : ''} ${!isEditable ? 'disabled' : ''}>
                        <label class="form-check-label w-100" for="${containerId}-${checkId}">
                            ${item}
                        </label>
                    </div>
                `;
                listContainer.appendChild(li);
            });

            if (isEditable) {
                listContainer.addEventListener('change', function(event) {
                    if (event.target.type === 'checkbox') {
                        const listItem = event.target.closest('.list-group-item');
                        if (event.target.checked) {
                            listItem.classList.add('checked');
                        } else {
                            listItem.classList.remove('checked');
                        }
                        updateCheckStatus(event.target.id.replace(`${containerId}-`, ''), event.target.checked);
                    }
                });
            }
        }

        function renderFilteredLists() {
            if (!currentEmployeeId) return;
            const employeeData = findEmployeeById(currentEmployeeId);
            if (!employeeData) return;

            const completedList = document.getElementById('checklist-completed');
            const inProgressList = document.getElementById('checklist-inprogress');

            completedList.innerHTML = '';
            inProgressList.innerHTML = '';

            checklistData.forEach((item, index) => {
                const checkId = `check${index + 1}`;
                const isChecked = employeeData.checks[checkId];
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `<i class="bi ${isChecked ? 'bi-check-circle-fill status-done' : 'bi-circle status-pending'}"></i> ${item}`;

                if (isChecked) {
                    completedList.appendChild(li);
                } else {
                    inProgressList.appendChild(li);
                }
            });
        }
        
        function renderSummaryModalContent() {
            if (!currentEmployeeId) return;
            const employeeData = findEmployeeById(currentEmployeeId);
            if (!employeeData) return;

            const summaryList = document.getElementById('modal-summary-list');
            const summaryEmployeeName = document.getElementById('modal-summary-employee-name');
            const progressBar = document.getElementById('modalProgressBar');

            summaryEmployeeName.textContent = employeeData.employeeName || '[Nama Belum Diisi]';
            summaryList.innerHTML = '';

            let completedCount = 0;
            checklistData.forEach((item, index) => {
                const checkId = `check${index + 1}`;
                const isChecked = employeeData.checks[checkId];
                if (isChecked) completedCount++;

                const div = document.createElement('div');
                div.className = 'summary-item';
                div.innerHTML = `
                    <span>${item}</span>
                    <i class="bi ${isChecked ? 'bi-check-circle-fill status-done' : 'bi-circle status-pending'}"></i>
                `;
                summaryList.appendChild(div);
            });

            const percentage = Math.round((completedCount / checklistData.length) * 100);
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            progressBar.textContent = `${percentage}%`;
        }

        // --- PAGE NAVIGATION & ACTIONS ---
        function showPage(pageName, linkElement) {
            if (pageName !== 'daftar-pegawai' && pageName !== 'pengaturan' && !currentEmployeeId) {
                showToast('Pilih pegawai terlebih dahulu dari daftar.', 'warning');
                return;
            }

            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.bottom-navbar .nav-link').forEach(link => link.classList.remove('active'));

            document.getElementById(`page-${pageName}`).classList.add('active');
            if (linkElement) linkElement.classList.add('active');

            if (pageName === 'ceklist') {
                renderChecklist('checklist-detail', findEmployeeById(currentEmployeeId), true);
            } else if (pageName === 'selesai' || pageName === 'proses') {
                renderFilteredLists();
            }
        }

        function showEmployeeList() {
            currentEmployeeId = null;
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById('page-daftar-pegawai').classList.add('active');
            document.querySelectorAll('.bottom-navbar .nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('.bottom-navbar .nav-link').classList.add('active');
            
            // Disable nav links that need an employee
            document.getElementById('nav-ceklist').classList.add('disabled');
            document.getElementById('nav-rangkuman').classList.add('disabled');
        }
        
        function loadEmployeeDetail(employeeId) {
            currentEmployeeId = employeeId;
            const employeeData = findEmployeeById(employeeId);
            if (!employeeData) return;

            document.getElementById('detail-employee-name').textContent = employeeData.employeeName;
            document.getElementById('summary-employee-name').textContent = employeeData.employeeName;
            
            renderChecklist('checklist-detail', employeeData, true);
            
            // Enable nav links
            document.getElementById('nav-ceklist').classList.remove('disabled');
            document.getElementById('nav-rangkuman').classList.remove('disabled');

            showPage('ceklist', document.getElementById('nav-ceklist'));
        }
        
        function updateCheckStatus(checkId, isChecked) {
            if (!currentEmployeeId) return;
            const employees = getAllEmployees();
            const employeeIndex = employees.findIndex(emp => emp.id === currentEmployeeId);
            if (employeeIndex !== -1) {
                employees[employeeIndex].checks[checkId] = isChecked;
                saveAllEmployees(employees);
                showToast('Data berhasil disimpan otomatis.', 'success');
                renderEmployeeList(); // Update progress bar in list
            }
        }

        function deleteCurrentEmployee() {
            if (!currentEmployeeId) return;
            const employeeData = findEmployeeById(currentEmployeeId);
            if (!employeeData) return;

            if (confirm(`Apakah Anda yakin ingin menghapus data untuk "${employeeData.employeeName}"?`)) {
                let employees = getAllEmployees();
                employees = employees.filter(emp => emp.id !== currentEmployeeId);
                saveAllEmployees(employees);
                showToast('Data pegawai berhasil dihapus.', 'success');
                showEmployeeList();
            }
        }

        function exportCurrentEmployeeData() {
            if (!currentEmployeeId) return;
            const employeeData = findEmployeeById(currentEmployeeId);
            if (!employeeData) return;
            
            const dataStr = JSON.stringify(employeeData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `data-pegawai-${employeeData.employeeName.replace(/\s+/g, '-').toLowerCase() || 'tanpa-nama'}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Data berhasil diekspor.', 'success');
        }

        // --- TELEGRAM FUNCTION ---
        function sendCurrentEmployeeDataToTelegram() {
            if (!currentEmployeeId) {
                showToast('Tidak ada pegawai yang dipilih.', 'warning');
                return;
            }

            const employeeData = findEmployeeById(currentEmployeeId);
            if (!employeeData) {
                showToast('Data pegawai tidak ditemukan.', 'danger');
                return;
            }

            // 1. Format pesan
            let completedItems = [];
            let pendingItems = [];

            checklistData.forEach((item, index) => {
                const checkId = `check${index + 1}`;
                if (employeeData.checks[checkId]) {
                    completedItems.push(`âœ… ${item}`);
                } else {
                    pendingItems.push(`âŒ ${item}`);
                }
            });

            const completedCount = completedItems.length;
            const totalCount = checklistData.length;
            const percentage = Math.round((completedCount / totalCount) * 100);

            let messageText = `ðŸ“‹ *Laporan Kelengkapan File Pegawai*\n\n`;
            messageText += `ðŸ‘¤ *Nama:* ${employeeData.employeeName}\n`;
            messageText += `ðŸ“Š *Progress:* ${percentage}% (${completedCount}/${totalCount})\n\n`;
            
            messageText += `*File yang sudah lengkap:*\n`;
            messageText += completedItems.join('\n') || 'Tidak ada.';
            messageText += `\n\n*File yang belum lengkap:*\n`;
            messageText += pendingItems.join('\n') || 'Semua sudah lengkap!';

            // 2. Kirim permintaan ke API Telegram
            const telegramUrl = `https://api.telegram.org/bot${telegramBotToken}/sendMessage`;

            const params = new URLSearchParams();
            params.append('chat_id', telegramChatId);
            params.append('text', messageText);
            params.append('parse_mode', 'Markdown'); // Menggunakan Markdown untuk formatting

            showToast('Sedang mengirim ke Telegram...', 'info');

            fetch(telegramUrl, {
                method: 'POST',
                body: params
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showToast('Data berhasil dikirim ke Telegram!', 'success');
                } else {
                    showToast(`Gagal mengirim: ${data.description}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Error sending to Telegram:', error);
                showToast('Terjadi kesalahan jaringan saat mengirim ke Telegram.', 'danger');
            });
        }

        function exportAllData() {
            const allEmployees = getAllEmployees();
            const dataStr = JSON.stringify(allEmployees, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `all-pegawai-data-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Semua data berhasil diekspor.', 'success');
        }

        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        saveAllEmployees(importedData);
                        renderEmployeeList();
                        showToast('Data berhasil diimpor.', 'success');
                        showEmployeeList();
                    } else {
                        showToast('File JSON tidak valid. Harap gunakan file yang diekspor dari aplikasi ini.', 'danger');
                    }
                } catch (error) {
                    showToast('Gagal membaca file JSON. Pastikan formatnya benar.', 'danger');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearAllEmployeeData() {
            if (confirm('PERINGATAN: Ini akan menghapus SEMUA data pegawai secara permanen dan tidak dapat dibatalkan. Apakah Anda yakin?')) {
                if (confirm('Konfirmasi terakhir: Apakah Anda benar-benar yakin ingin menghapus semua data?')) {
                    localStorage.removeItem(storageKey);
                    showToast('Semua data pegawai telah dihapus.', 'danger');
                    showEmployeeList(); // Kembali ke daftar dan refresh tampilan
                }
            }
        }

        // --- MODAL MANAGEMENT ---
        function showAddEmployeeModal() {
            document.getElementById('modalEmployeeNameInput').value = '';
            renderChecklist('checklist-modal', null, true); // Render checklist kosong untuk modal
            addEmployeeModal.show();
        }

        function saveNewEmployee() {
            const name = document.getElementById('modalEmployeeNameInput').value.trim();
            if (!name) {
                alert('Nama pegawai harus diisi.');
                return;
            }

            const newEmployeeChecks = {};
            document.querySelectorAll('#checklist-modal input[type="checkbox"]').forEach((checkbox, index) => {
                newEmployeeChecks[`check${index + 1}`] = checkbox.checked;
            });

            const newEmployee = {
                id: generateUniqueId(),
                employeeName: name,
                checks: newEmployeeChecks
            };

            const employees = getAllEmployees();
            employees.push(newEmployee);
            saveAllEmployees(employees);

            addEmployeeModal.hide();
            showToast('Pegawai baru berhasil ditambahkan.', 'success');
            renderEmployeeList();
        }

        function showSummaryModal() {
            if (!currentEmployeeId) return;
            renderSummaryModalContent();
            summaryModal.show();
        }

        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('saveNotificationToast');
            const toastBody = toastEl.querySelector('.toast-body');
            const iconClass = type === 'success' ? 'check-circle' : (type === 'danger' ? 'exclamation-triangle' : (type === 'info' ? 'info-circle' : 'exclamation-circle'));
            const textClass = type === 'success' ? 'success' : (type === 'danger' ? 'danger' : (type === 'info' ? 'info' : 'warning'));
            toastBody.innerHTML = `<i class="bi bi-${iconClass}-fill text-${textClass} me-2"></i> ${message}`;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            // Mengosongkan semua data pegawai saat halaman dimuat
            localStorage.removeItem(storageKey);
            
            saveNotificationToast = new bootstrap.Toast(document.getElementById('saveNotificationToast'));
            addEmployeeModal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
            summaryModal = new bootstrap.Modal(document.getElementById('summaryModal'));
            
            renderEmployeeList();
        });
    </script>
</body>
</html>
